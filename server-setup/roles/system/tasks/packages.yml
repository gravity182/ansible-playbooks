---
- name: Perform apt full-upgrade
  when: apt_upgrade | bool
  ansible.builtin.apt:
    upgrade: "full"
    update_cache: true
    cache_valid_time: 0
    autoremove: true
    autoclean: true
    # confdef: if the conffile was not modified locally -> install the maintainerâ€™s new version automatically
    # confold: if the conffile was modified locally -> keep your existing (old) one automatically
    dpkg_options: "force-confdef,force-confold"
  become: true

- name: Set up apt auto-upgrades
  block:
    - name: Install unattended-upgrades
      ansible.builtin.apt:
        package: unattended-upgrades
        state: present
      become: true

    - name: Configure auto-upgrades
      ansible.builtin.copy:
        src: "20auto-upgrades"
        dest: "/etc/apt/apt.conf.d/20auto-upgrades"
        mode: "0644"
        owner: root
        group: root
      become: true

    - name: Configure unattended-upgrades
      ansible.builtin.copy:
        src: "50unattended-upgrades"
        dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
        mode: "0644"
        owner: root
        group: root
      become: true

    - name: Enable unattended-upgrades service
      ansible.builtin.systemd:
        name: unattended-upgrades
        state: started
        enabled: true
      become: true

    - name: Enable apt daily timers
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - apt-daily.timer
        - apt-daily-upgrade.timer
      become: true

- name: Install useful system utilities
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
    name: "{{ system_packages }}"
    state: present
  become: true
